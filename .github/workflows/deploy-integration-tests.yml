name: Deploy Integration Tests

on: [push]

jobs:
  deploy-integration-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Python 3.12
        uses: actions/setup-python@v2.2.1
        with:
          python-version: 3.12

      - name: Checkout repository and submodules
        uses: actions/checkout@v2

      - name: Install and configure Poetry
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: true
        uses: snok/install-poetry@v1
        with:
          version: 1.8.3
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      # - name: Install Dependencies
      #   run: poetry install --no-interaction --no-root
      #   if: steps.cache.outputs.cache-hit != 'true'
        
      - name: Configure Beam
        env:
          BETA9_CONFIG: ${{ secrets.BETA9_CONFIG }}
        run: |
          poetry export --without-hashes --format=requirements.txt > requirements.txt
          pip install -r requirements.txt
          mkdir ~/.beta9
          touch ~/.beta9/config.ini
          echo $BETA9_CONFIG >> ~/.beta9/config.ini
          cat ~/.beta9/config.ini

      - name: Deploy
        run: cd tests && beta9 deploy app.py:run_tests -n integration-tests
